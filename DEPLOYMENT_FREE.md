# Деплой по шагам (бесплатно: Neon + Render)

Делай всё по порядку. Сначала база, потом сайт.

---

## БЛОК 1: База данных (Neon)

### Шаг 1 — Открыть Neon

1. Открой в браузере: **https://neon.tech**
2. Нажми **Sign up** (или **Log in**, если уже есть аккаунт).
3. Войди через **GitHub** — так проще.

### Шаг 2 — Создать проект

1. На главной нажми кнопку **New Project**.
2. В поле **Project name** введи: `mypersonalsite` (или любое имя).
3. **Region** оставь как есть (например, US East).
4. Нажми **Create Project**.

### Шаг 3 — Скопировать строку подключения

1. После создания откроется дашборд проекта.
2. Вверху справа нажми кнопку **Connect**.
3. В выпадающем списке выбери **Connection string** (или **Laravel**, если есть).
4. Скопируй строку — она выглядит так:
   ```text
   postgresql://neondb_owner:xxxxx@ep-xxx-xxx.region.aws.neon.tech/neondb?sslmode=require
   ```
5. Сохрани её в блокнот — понадобится на Render.  
   **Важно:** не публикуй эту строку нигде, в ней пароль.

На этом с Neon всё. База создана, строка подключения есть.

---

## БЛОК 2: Сайт на Render

### Шаг 4 — Открыть Render

1. Открой: **https://render.com**
2. Нажми **Get Started** (или **Log in**).
3. Войди через **GitHub**.

### Шаг 5 — Создать Web Service

1. В личном кабинете Render нажми **New +** (или **Create new**).
2. В списке выбери **Web Service**.
3. Если Render спросит доступ к репозиториям — разреши доступ к GitHub и выбери репозиторий **mypersonalsite**.
4. В списке репозиториев нажми на **mypersonalsite** (или подключи репо по инструкции на экране).
5. Нажми **Connect** рядом с репозиторием.

### Шаг 6 — Заполнить настройки сервиса

На странице создания сервиса заполни так:

| Поле | Что сделать |
|------|-------------|
| **Name** | Введи: `mypersonalsite` (или другое имя — из него будет URL). |
| **Region** | Выбери, например, **Frankfurt (EU Central)**. |
| **Branch** | Должно быть **main**. |
| **Root Directory** | Оставь пустым. |
| **Language** | В выпадающем списке выбери **Docker** (не Node). От этого поля зависит, что будет собираться: при Docker сборка идёт по Dockerfile. |
| **Build Command** | Если поле **обязательное** и не исчезает при выборе Docker — вставь одну из строк: `true` или `echo "Docker"`. При Language = Docker Render всё равно собирает образ из Dockerfile, это значение не используется. |
| **Start Command** | Оставь пустым (запуск задаётся в Dockerfile). |

**Важно:** В Render тип окружения задаётся полем **Language** (не Runtime). Обязательно выбери **Docker**, иначе будет среда Node и команда `composer` не найдётся.

Остальное пока не трогай.

### Шаг 7 — Добавить переменные окружения

1. Прокрути страницу вниз до блока **Environment** (или **Environment Variables**).
2. Нажми **Add Environment Variable** (или **+ Add**).
3. Добавь переменные **по одной** (Key и Value):

| Key | Value |
|-----|--------|
| `APP_NAME` | `Denis Underonov` |
| `APP_ENV` | `production` |
| `APP_DEBUG` | `false` |
| `APP_KEY` | Сгенерируй локально: в терминале в папке проекта выполни `php artisan key:generate --show` и вставь вывод (начинается с `base64:...`). |
| `APP_URL` | Пока напиши: `https://mypersonalsite.onrender.com` (если Name был другой — подставь его вместо mypersonalsite). |
| `APP_LOCALE` | `ru` |
| `APP_FALLBACK_LOCALE` | `ru` |
| `LOG_LEVEL` | `error` |
| `DB_CONNECTION` | `pgsql` |
| `DB_URL` | Вставь **целиком** строку подключения из Neon (из шага 3). |
| `SESSION_DRIVER` | `database` |
| `SESSION_SECURE_COOKIE` | `true` |
| `CACHE_STORE` | `database` |
| `QUEUE_CONNECTION` | `database` |
| `ADMIN_EMAIL` | Твой email для входа в админку (не попадает в код). |
| `ADMIN_PASSWORD` | Пароль админа (не попадает в код). |
| `ADMIN_NAME` | Имя (например Denis Underonov), опционально. |

4. Проверь, что **DB_URL** — именно та длинная строка из Neon, с `postgresql://...` и `?sslmode=require` в конце.

### Шаг 8 — Запустить деплой

1. Внизу страницы нажми **Create Web Service**.
2. Render начнёт сборку и деплой (5–10 минут).
3. Вверху появится ссылка вида `https://mypersonalsite.onrender.com` — это твой сайт. Пока идёт деплой, она может открываться с ошибкой — подожди до зелёного статуса **Live**.

### Шаг 9 — Обновить APP_URL (если Render дал другой URL)

1. Если вверху у сервиса другой адрес (например `https://mypersonalsite-xxxx.onrender.com`), скопируй его.
2. В Render открой свой сервис → слева **Environment**.
3. Найди переменную **APP_URL** и измени значение на этот точный URL (с `https://`).
4. Сохрани (Save) — Render перезапустит сервис с новым APP_URL.

### Шаг 10 — Админ создаётся при деплое

Админ создаётся автоматически из переменных **ADMIN_EMAIL**, **ADMIN_PASSWORD**, **ADMIN_NAME** (они задаются только в Environment на Render, в коде их нет). После деплоя открой `/admin/login` и войди с этими данными.

---

## Готово: проверка

1. Открой в браузере ссылку на сервис (например `https://mypersonalsite.onrender.com`).
2. Должна открыться главная страница сайта.
3. Перейди на `https://mypersonalsite.onrender.com/admin/login`.
4. Войди с теми **ADMIN_EMAIL** и **ADMIN_PASSWORD**, которые указал в Environment на Render.

Если всё открылось и вход в админку прошёл — деплой завершён.

---

## Краткий чек-лист

- [ ] Neon: зарегистрировался, создал проект, скопировал Connection string.
- [ ] Render: создал Web Service от репозитория mypersonalsite.
- [ ] Render: указал все переменные, в том числе APP_KEY, DB_URL, ADMIN_EMAIL, ADMIN_PASSWORD.
- [ ] Render: нажал Create Web Service, дождался зелёного Live.
- [ ] Админ создаётся при деплое автоматически (Shell не нужен).
- [ ] Открыл сайт и `/admin/login`, проверил вход.

---

## Если что-то пошло не так

- **Ошибка про APP_KEY** — добавь в Environment переменную `APP_KEY` (команда: `php artisan key:generate --show`).
- **Ошибка подключения к БД** — проверь `DB_URL`: скопировал ли всю строку из Neon, есть ли в конце `?sslmode=require`.
- **500 на сайте** — открой в Render вкладку **Logs** и посмотри текст ошибки внизу лога.
- **Не грузятся стили** — убедись, что `APP_URL` в Environment точно совпадает с URL сайта в браузере (с `https://`).

### Ошибка миграций: «current transaction is aborted» / DROP TABLE

В миграциях отключена общая транзакция (`$withinTransaction = false`), чтобы каждый DDL выполнялся отдельно и не ломал следующие команды на Neon.

**Если ошибка всё равно есть** — попробуй **прямое** подключение к Neon (без pooler). В Neon в разделе Connect есть два варианта строки: с `-pooler` в хосте (для приложения) и без (direct). В Render в переменной `DB_URL` укажи строку **без** `-pooler` в адресе, например:
`postgresql://neondb_owner:ПАРОЛЬ@ep-green-wind-aiwyaja6.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require`
(замени хост и пароль на свои из Neon; direct-хост обычно без слова `-pooler`).

### Ошибка миграций: «users_email_unique» (уже исправлено в коде)

Так бывает, если миграции когда-то частично выполнились и база в Neon осталась в некорректном состоянии. Нужно один раз сбросить схему и заново применить миграции.

**Вариант 1 — сброс в Neon (рекомендуется):**

1. Зайди в [Neon Console](https://console.neon.tech), открой свой проект.
2. Слева выбери **SQL Editor**.
3. Выполни по очереди:
   ```sql
   DROP SCHEMA public CASCADE;
   CREATE SCHEMA public;
   GRANT ALL ON SCHEMA public TO neondb_owner;
   GRANT ALL ON SCHEMA public TO public;
   ```
   (если у тебя другой владелец БД — замени `neondb_owner` на него или выполни только первые две строки).
4. Сохрани изменения, затем в Render нажми **Manual Deploy** → **Deploy latest commit**. Миграции выполнятся заново на чистой схеме.

**Вариант 2 — через Render Shell** (если доступен):

1. В Render открой сервис → **Shell**.
2. Выполни: `php artisan migrate:fresh --force`, затем `php artisan db:seed --class=AdminUserSeeder --force`.
3. Обнови страницу сайта. (Если Shell платный — админ и так создаётся при каждом деплое.)

**Вариант 3 — сброс через переменную окружения (без правки Neon):**

1. В Render открой сервис → **Environment** → **Add Environment Variable**.
2. Добавь переменную: ключ `RUN_MIGRATE_FRESH`, значение `1`. Сохрани (Render перезапустит деплой).
3. Дождись успешного деплоя — миграции выполнятся заново (таблицы будут пересозданы).
4. Админ создаётся при деплое автоматически (Shell не нужен).
5. В **Environment** удали переменную `RUN_MIGRATE_FRESH` и сохрани.

---

## Безопасность: данные админа не в коде

Email и пароль админа **не хранятся в репозитории**. Они задаются только в переменных окружения:
- на Render — в **Environment** (ADMIN_EMAIL, ADMIN_PASSWORD, ADMIN_NAME);
- локально — в `.env` (файл в `.gitignore`, в Git не попадает).

В коде только чтение из `env('ADMIN_EMAIL')` и т.д. Реальные значения задаёшь только ты.

---

## Восстановление старых данных в БД

Зависит от того, где были «старые» данные.

**1. Данные были в локальной SQLite** (файл `database/database.sqlite`)

- Если файл ещё есть — можно выгрузить данные и перенести в Neon.
- В папке проекта выполни (подключив к SQLite):  
  `php artisan db:seed` не восстанавливает произвольные данные; нужен экспорт.
- Вариант: установи [pgloader](https://pgloader.io/) или используй скрипт экспорта из SQLite в CSV/SQL, затем импорт в PostgreSQL (Neon). Или экспортируй таблицы из SQLite в SQL и вручную поправь синтаксис под PostgreSQL и выполни в Neon → SQL Editor.
- Простой вариант для небольших объёмов: если есть админ, статьи, проекты, фото — можно один раз вручную заново внести их через админку после деплоя.

**2. Данные были в Neon** (уже деплоили на Render с Neon)

- В [Neon Console](https://console.neon.tech) открой проект → **Backup & Restore** (или **Branches**). На бесплатном тарифе может быть ограниченный срок хранения.
- Если есть точка восстановления — создай ветку (branch) от нужного момента или восстанови по инструкции Neon.
- Иначе старые данные вернуть нельзя, если бэкапа нет.

**3. Данные были на Railway** (или другом хостинге)

- Если там был экспорт/бэкап БД — скачай дамп и залей его в Neon через `psql` или Neon SQL Editor (в зависимости от формата дампа).
- Если бэкапа не делал — восстановить можно только из своих локальных копий (SQLite, экспорты и т.п.).

**Итог:** чтобы не терять данные в будущем, периодически делай бэкап: в Neon используй **Backup & Restore** или экспорт таблиц через SQL Editor; при необходимости сохраняй дамп к себе на компьютер.
